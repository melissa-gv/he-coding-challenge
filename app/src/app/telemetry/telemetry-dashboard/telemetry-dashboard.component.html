<section class="telemetry-shell shared-panel">
  <header class="telemetry-header shared-section-header">
    <div>
      <p class="shared-kicker">Asset Monitoring / Telemetry Comparison</p>
      <h2>Telemetry Display</h2>
      <p class="shared-subtitle">Select up to 3 assets and compare live operating metrics at a glance.</p>
    </div>

    <div class="live-panel">
      <p class="live-line"><span class="live-dot"></span>Live</p>
      @if (lastLiveUpdate()) {
        <p class="live-time">{{ lastLiveUpdate() | date: 'mediumTime' }}</p>
      }
      <p-button
        label="Refresh"
        icon="pi pi-refresh"
        styleClass="refresh-button"
        (onClick)="refreshTelemetry()"
      />
    </div>
  </header>

  @if (isLoadingAssets()) {
    <p-message severity="info" text="Loading telemetry assets..." styleClass="telemetry-message" />
  } @else {
    <app-telemetry-asset-selector
      [assets]="assets()"
      [selectedAssetIds]="selectedAssetIds()"
      [maxSelection]="3"
      (selectedAssetIdsChange)="onSelectedAssetIdsChange($event)"
    />

    @if (assetsError()) {
      <p-message severity="error" [text]="assetsError() ?? ''" styleClass="telemetry-message" />
    } @else if (telemetryError()) {
      <p-message severity="error" [text]="telemetryError() ?? ''" styleClass="telemetry-message" />
    } @else if (!selectedAssetIds().length) {
      <p-message severity="warn" text="Select at least one asset to view telemetry." styleClass="telemetry-message" />
    } @else {
      @if (isLoadingTelemetry() && !hasTelemetryData()) {
        <p-message severity="info" text="Loading telemetry data..." styleClass="telemetry-message" />
      }

      <section class="telemetry-grid" [style.--selected-count]="selectedAssets().length">
        @for (metric of metrics; track metric.key) {
          <article class="metric-label-card">
            <p>{{ metric.label }}</p>
            <span>{{ metric.unit }}</span>
          </article>

          @for (asset of selectedAssets(); track asset.id) {
            <app-telemetry-metric-card
              [assetName]="asset.name"
              [assetType]="asset.type"
              [status]="telemetryStatus(asset.id)"
              [metricLabel]="metric.label"
              [unit]="metric.unit"
              [value]="metricValue(asset.id, metric.key)"
              [delta]="metricDelta(asset.id, metric.key)"
              [meterPercent]="meterPercent(asset.id, metric)"
              [severity]="metricSeverity(asset.id, metric)"
            />
          }
        }
      </section>
    }
  }
</section>
