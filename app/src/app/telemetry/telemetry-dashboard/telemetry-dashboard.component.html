<section class="shared-panel">
  <header class="telemetry-header shared-section-header">
    <div>
      <p class="shared-kicker">Asset Monitoring / Telemetry Comparison</p>
      <h2>Telemetry Display</h2>
      <p class="shared-subtitle">Select up to 3 assets and compare live operating metrics at a glance.</p>
    </div>

    <div class="live-panel">
      <p class="live-line"><span class="live-dot"></span>Live</p>
      @if (lastLiveUpdate()) {
        <p class="live-time">{{ lastLiveUpdate() | date: 'mediumTime' }}</p>
      }
      <p-button
        label="Refresh"
        icon="pi pi-refresh"
        (onClick)="refreshTelemetry()"
      />
    </div>
  </header>

  @if (isLoadingAssets()) {
    <p-message severity="info">Loading telemetry assets...</p-message>
  } @else {
    <app-telemetry-asset-selector
      [assets]="assets()"
      [selectedAssetIds]="selectedAssetIds()"
      [maxSelection]="3"
      (selectedAssetIdsChange)="onSelectedAssetIdsChange($event)"
    />

    @if (assetsError()) {
      <p-message severity="error">{{ assetsError() ?? '' }}</p-message>
    } @else if (telemetryError()) {
      <p-message severity="error">{{ telemetryError() ?? '' }}</p-message>
    } @else if (!selectedAssetIds().length) {
      <p-message severity="warn">Select at least one asset to view telemetry.</p-message>
    } @else {
      @if (isLoadingTelemetry() && !hasTelemetryData()) {
        <p-message severity="info">Loading telemetry data...</p-message>
      }

      <section class="telemetry-grid" [style.--selected-count]="selectedAssets().length">
        @for (metric of metrics; track metric.key) {
          <div class="metric-label-card">
            <p>{{ metric.label }}</p>
            <span>{{ metric.unit }}</span>
          </div>

          @for (asset of selectedAssets(); track asset.id) {
            <app-telemetry-metric-card
              [assetName]="asset.name"
              [assetType]="asset.type"
              [status]="telemetryStatus(asset.id)"
              [metricLabel]="metric.label"
              [unit]="metric.unit"
              [value]="metricValue(asset.id, metric.key)"
            />
          }
        }
      </section>
    }
  }
</section>
